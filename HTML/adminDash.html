<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">
  <title>Admin Dashboard - Eventify</title>

  <link href="../assets/img/favicon.png" rel="icon">
  <link href="../assets/img/apple-touch-icon.png" rel="apple-touch-icon">

  <link href="https://fonts.googleapis.com" rel="preconnect">
  <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Poppins:wght@400;600&family=Raleway:wght@400;600&display=swap"
    rel="stylesheet">

  <link href="../assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <link href="../assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
  <link href="../assets/vendor/aos/aos.css" rel="stylesheet">
  <link href="../assets/vendor/swiper/swiper-bundle.min.css" rel="stylesheet">
  <link href="../assets/vendor/glightbox/css/glightbox.min.css" rel="stylesheet">

  <link href="../assets/css/main.css" rel="stylesheet">
</head>

<body class="index-page">

  <!-- Header -->
  <header id="header" class="header d-flex align-items-center fixed-top">
    <div class="container-fluid container-xl d-flex align-items-center justify-content-between">
      <a href="Admin_dashboard.html" class="logo d-flex align-items-center me-auto me-lg-0">
        <h1 class="sitename" style="color: burlywood;">EVENTIFY</h1>
      </a>
      <nav id="navmenu" class="navmenu">
        <ul>
          <li><a href="My Events.html">My Events</a></li>
          <li><a href="Events.html">All Events</a></li>
          <li><a href="#">Archived Events</a></li>          
          <li><a href="adminAccount.html">My Account</a></li>
          <button id="logoutBtn" style="background:none; border:none; cursor:pointer;">
            <a class="btn-getstarted" href="#" style="color: blanchedalmond;">Log-out</a>
          </button>
        </ul>
        <i class="mobile-nav-toggle d-xl-none bi bi-list"></i>
      </nav>
    </div>
  </header>

  <main class="main">

    <!-- Hero Section -->
    <section id="hero" class="hero section dark-background">
      <div class="container" style="height: 60vh;">
        <div id="chatbot-container" style="position: fixed; bottom: 20px; right: 20px; display: none;">
          <iframe id="chatbot-frame" style="border:none;" height="400px" width="300px"
            src="https://widget.kommunicate.io/chat?appId=23578c013b4c7c9d1efbca7aff236ed0f"></iframe>
        </div>

        <!-- <button id="chatbot-toggle" style="position: fixed; bottom: 20px; right: 200px; z-index: 1000;">Chat</button> -->
        <button id="chatbot-toggle"
            style="background: none; border: none; padding: 0; font: inherit; cursor: pointer; outline: inherit; position: fixed; bottom: 20px; left: 2vh; z-index: 1000;">
            <a class="btn-getstarted" href="#" style="color: blanchedalmond;">Chat with us!</a>
          </button>
        <div class="row gy-4 mt-5 justify-content-center" data-aos="fade-up" data-aos-delay="200"
          style="display: grid; grid-template-columns: repeat(3, 340px);">
          <div style="grid-column:1/-1; text-align:center; font-size:40px; font-weight:500; margin-bottom:5px;">
            Published Events
          </div>
          <div style="grid-column:1/-1; text-align:center; margin-bottom:30px;">
            <input type="text" id="eventSearch" class="form-control" placeholder="Search your events..."
              style="max-width:300px; display:inline-block; background-color:transparent; border:1px solid #fff; color:#fff; padding:5px 10px; border-radius:5px;">
          </div>

          <!-- Add Event Card -->
          <div class="col-xl-2 col-md-4 event-card" style="width:40vh;" data-aos="fade-up" data-aos-delay="800">
            <div class="icon-box d-flex flex-column justify-content-center align-items-center"
              style="cursor:pointer;" data-bs-toggle="modal" data-bs-target="#addEventModal">
              <i class="bi bi-plus-circle" style="font-size:2.5rem; color:#28a745;"></i>
              <h3><a href="javascript:void(0)">Add Event</a></h3>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Footer -->
    <footer id="footer" class="footer dark-background">
      <div class="footer-top">
        <div class="container">
          <div class="row gy-4">
            <div class="col-lg-4 col-md-6 footer-about">
              <a href="index.html" class="logo d-flex align-items-center">
                <span class="sitename">Contact US</span>
              </a>
              <div class="social-links d-flex mt-4">
                <a href=""><i class="bi bi-twitter-x"></i></a>
                <a href=""><i class="bi bi-facebook"></i></a>
                <a href=""><i class="bi bi-instagram"></i></a>
                <a href=""><i class="bi bi-linkedin"></i></a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </footer>

    <a href="#" id="scroll-top" class="scroll-top d-flex align-items-center justify-content-center">
      <i class="bi bi-arrow-up-short"></i>
    </a>

    <div id="preloader"></div>
  </main>

  <!-- Add Event Modal -->
  <div class="modal fade" id="addEventModal" tabindex="-1" aria-labelledby="addEventLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">

        <div class="modal-header">
          <h5 class="modal-title" id="addEventLabel">Create New Event</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">
          <form id="addEventForm">
            <div class="mb-3">
              <label for="eventTitle" class="form-label">Event Title</label>
              <input type="text" class="form-control" id="eventTitle" placeholder="e.g. Hackathon 2025">
            </div>
            <div class="mb-3">
              <label for="eventDetails" class="form-label">Description</label>
              <textarea class="form-control" id="eventDetails" rows="3"></textarea>
            </div>
            <div class="mb-3">
              <label for="eventDate" class="form-label">Date</label>
              <input type="date" class="form-control" id="eventDate">
            </div>
            <div class="mb-3">
              <label for="eventRules" class="form-label">Rules</label>
              <textarea class="form-control" id="eventRules" rows="3"></textarea>
            </div>
            <div class="mb-3">
              <label for="eventPlatform" class="form-label">Platform</label>
              <input type="text" class="form-control" id="eventPlatform">
            </div>
            <div class="mb-3">
              <label for="eventRegFee" class="form-label">Registration Fee</label>
              <input type="number" class="form-control" id="eventRegFee">
            </div>
            <div class="mb-3">
              <label for="eventStatus" class="form-label">Status</label>
              <select class="form-select" id="eventStatus">
                <option value="Publish">Publish</option>
                <option value="Archive">Archive</option>
              </select>
            </div>
          </form>
        </div>

        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button class="btn btn-success" id="saveEventBtn">Save Event</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Event View Modal -->
  <div class="modal fade" id="eventModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content bg-dark text-white" style="background:rgba(0,0,0,0.85); border-radius:15px;">
        <div class="modal-header">
          <h5 class="modal-title" id="eventModalLabel" style="color: burlywood;">Event Title</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <h6 style="color: burlywood;">Description:</h6>
          <p id="eventDescription"></p>
          <h6 style="color: burlywood;">Rules:</h6>
          <p id="eventRulesList"></p>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="../assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
  <script src="../assets/vendor/aos/aos.js"></script>
  <script src="../assets/vendor/swiper/swiper-bundle.min.js"></script>
  <script src="../assets/vendor/glightbox/js/glightbox.min.js"></script>
  <script src="../assets/js/main.js"></script>

  <script>
    // Save Event
    document.getElementById("saveEventBtn").addEventListener("click", async () => {
      const title = document.getElementById("eventTitle").value;
      const description = document.getElementById("eventDetails").value;
      const date = document.getElementById("eventDate").value;
      const rules = document.getElementById("eventRules").value.split("\n").filter(r => r.trim() !== "");
      const platform = document.getElementById("eventPlatform").value;
      const reg_fee = document.getElementById("eventRegFee").value;
      const status = document.getElementById("eventStatus").value;

      console.log({ title, description, date, rules, platform, reg_fee, status }); // debug

      const res = await fetch("/api/admin/add-event", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ title, description, date, rules, platform, reg_fee, status })
      });

      const data = await res.json();
      if (data.success) {
        addCardToUI(data.event);
        document.getElementById("addEventForm").reset();
        bootstrap.Modal.getInstance(document.getElementById("addEventModal")).hide();
      } else {
        alert("Error: " + data.msg);
      }
    });
  </script>


  <script>
const container = document.querySelector(".row.gy-4.mt-5.justify-content-center");

// Add a single event card to the UI
function addCardToUI(event) {
  const addCard = container.querySelector('.bi-plus-circle')?.closest('.event-card');
  if (!addCard) return;

  const cardHTML = `
    <div class="col-xl-4 col-md-6 event-card" style="width:40vh;" data-aos="fade-up" data-aos-delay="300">
      <div class="icon-box text-center p-3" style="margin:2vh;">
        <i class="bi bi-binoculars" style="font-size:2rem;"></i>
        <h3 class="mt-2"><a href="#">${event.title}</a></h3>
        <div class="d-flex justify-content-center gap-2 mt-2">
          <a href="#" class="btn btn-sm btn-outline-light" data-bs-toggle="modal"
             data-bs-target="#eventModal"
             data-title="${event.title}"
             data-description="${event.description}"
             data-rules="${event.rules.join(", ")}"
             data-platform="${event.platform}"
             data-regfee="${event.reg_fee}"
             data-date="${new Date(event.date).toLocaleDateString()}">
            View Details
          </a>
        </div>
      </div>
    </div>`;
  
  addCard.insertAdjacentHTML("afterend", cardHTML);
}

// Fetch events based on type: my / all / archived
async function fetchEvents(type) {
  const addCard = container.querySelector('.bi-plus-circle')?.closest('.event-card');

  // Remove old event cards except Add Event
  container.querySelectorAll('.event-card').forEach(card => {
    if (card !== addCard) card.remove();
  });

  // Show or hide Add Event card
  if (addCard) {
    if (type === "all" || type === "archived") {
      addCard.style.display = "none"; // hide Add Event
    } else {
      addCard.style.display = ""; // show Add Event
    }
  }

  let url = "";
  if (type === "my") url = "/api/admin/events";
  else if (type === "all") url = "/api/events";
  else if (type === "archived") url = "/api/events/archived";

  try {
    const res = await fetch(url);
    const data = await res.json();
    if (data.success) data.events.forEach(ev => addCardToUI(ev));
  } catch (err) {
    console.error(err);
  }
}

// Event Modal setup
const eventModal = document.getElementById('eventModal');
eventModal.addEventListener('show.bs.modal', function(e) {
  const button = e.relatedTarget;
  document.getElementById('eventModalLabel').textContent = button.getAttribute('data-title');
  document.getElementById('eventDescription').textContent = button.getAttribute('data-description');
  document.getElementById('eventRulesList').textContent = button.getAttribute('data-rules');
});

// Navigation links click handling
document.querySelector('nav#navmenu ul').addEventListener('click', function(e) {
  if (e.target.tagName === 'A') {
    const text = e.target.textContent.toLowerCase();

    // Only intercept event-related links
    if (text.includes("all events") || text.includes("my events") || text.includes("archived")) {
      e.preventDefault();
      if (text.includes("all events")) fetchEvents("all");
      else if (text.includes("my events")) fetchEvents("my");
      else if (text.includes("archived")) fetchEvents("archived");
    }
    // Otherwise, normal navigation occurs
  }
});


// Search functionality
document.getElementById('eventSearch').addEventListener('input', function() {
  const query = this.value.toLowerCase();
  document.querySelectorAll('.event-card').forEach(card => {
    if (card.querySelector('.bi-plus-circle')) return; // skip Add Event card
    const title = card.querySelector('h3 a')?.innerText.toLowerCase() || "";
    const description = card.querySelector('[data-description]')?.getAttribute("data-description")?.toLowerCase() || "";
    const rules = card.querySelector('[data-rules]')?.getAttribute("data-rules")?.toLowerCase() || "";
    card.style.display = (title.includes(query) || description.includes(query) || rules.includes(query)) ? '' : 'none';
  });
});

// Logout button
document.getElementById("logoutBtn").addEventListener("click", async () => {
  try {
    const res = await fetch("/api/logout", { method: "POST" });
    const data = await res.json();
    if (data.success) window.location.href = "login.html";
  } catch (err) {
    console.error(err);
  }
});

// Initial load: fetch My Events once without triggering nav click
window.addEventListener("DOMContentLoaded", () => {
  fetchEvents("my");
});
</script>



<script>
    document.getElementById("logoutBtn").addEventListener("click", async () => {
      const res = await fetch("/api/logout", {
        method: "POST"
      });

      const data = await res.json();
      if (data.success) {
        //alert("Logged out successfully!");
        window.location.href = "login.html"; // redirect to login page
      }
    });
</script>

<script>
  const toggleBtn = document.getElementById('chatbot-toggle');
  const chatContainer = document.getElementById('chatbot-container');

  toggleBtn.addEventListener('click', () => {
    if (chatContainer.style.display === 'none') {
      chatContainer.style.display = 'block';
    } else {
      chatContainer.style.display = 'none';
    }
  });

</script>   

</body>
</html>